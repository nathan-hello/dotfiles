#!/bin/sh
#
# Manages up to 3 network bridges for a QEMU VM.
# Maps the provided physical interfaces to br0, br1, and br2.
#
# set -eu

# --- Functions ---
usage() {
  echo "Usage: $(basename "$0") <action> [interface1] [interface2] ..."
  echo "Actions:"
  echo "  attach   - Create brX for each interface provided."
  echo "  detach   - Delete brX for each interface provided."
  exit 1
}

if [ "$#" -lt 2 ]; then
       	usage 
fi

ACTION="$1"
INTERFACE="$2"
BRIDGE_NAME="$3"

# Validate that the interface exists
if [ ! -d "/sys/class/net/$INTERFACE" ]; then
  echo "Error: Interface '$INTERFACE' not found. Aborting."
  exit 1
fi

echo "Processing '$INTERFACE' -> '$BRIDGE_NAME'..."

case "$ACTION" in
  attach)
    sudo ip link set "$INTERFACE" master "$BRIDGE_NAME"
    sudo ip link set "$BRIDGE_NAME" up
    sudo dhcpcd "$BRIDGE_NAME"
    ;;
  detach)
    if [ -d "/sys/class/net/$BRIDGE_NAME" ]; then
      sudo ip link set "$BRIDGE_NAME" down
      sudo ip link delete "$BRIDGE_NAME"
    fi
    sudo ip link set "$INTERFACE" nomaster || true
    sudo dhcpcd "$INTERFACE"
    ;;
  *)
    echo "Error: Invalid action specified."
    usage
    ;;
esac
