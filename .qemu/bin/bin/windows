#!/bin/bash
set -euo pipefail

QEMUPATH="$HOME/.qemu"
WINPATH="$QEMUPATH/win11"
ISOPATH="$QEMUPATH/iso"

DRIVEFILE="$WINPATH/win11_disk.qcow2"
VIRTIOFILE="$ISOPATH/virtio-win.iso"
WINISOFILE="$ISOPATH/win11.iso"
GPDISOFILE="$ISOPATH/gparted.iso" #-cdrom "$GPDISOFILE" \

# We need a writable copy of the VARS file for the VM to store boot settings.
OVMF_VARS_COPY="$WINPATH/win11_VARS.fd"
OVMF_CODE="/usr/share/edk2/x64/OVMF_CODE.fd"
QMP_SOCK="127.0.0.1:4444"

mkdir -p "$WINPATH" "$ISOPATH"

# Only copy the template if our own copy doesn't exist yet.
if [ ! -f "$OVMF_VARS_COPY" ]; then
    echo "Creating initial UEFI variable store..."
    cp "/usr/share/edk2/x64/OVMF_VARS.fd" "$OVMF_VARS_COPY"
fi


ensure_bridge() {
  local br="$1"
  if !ip link show "$br" >/dev/null 2>&1; then
    sudo ip link add "$br" type bridge
    sudo ip link set "$br" up
  fi
}

ensure_bridge br0
ensure_bridge br1
ensure_bridge br2

qemu-system-x86_64 \
  -enable-kvm \
  -machine q35 \
  -m 16G \
  -cpu host \
  -smp 12,cores=6 \
  \
  -drive if=pflash,format=raw,readonly=on,file="$OVMF_CODE" \
  -drive if=pflash,format=raw,file="$OVMF_VARS_COPY" \
  \
  -display gtk,gl=on \
  -device virtio-vga-gl,xres=2560,yres=1600 \
  \
  -drive file="$DRIVEFILE",format=qcow2,if=virtio \
  -drive file="$VIRTIOFILE",index=3,media=cdrom \
  -cdrom "$WINISOFILE" \
  \
  -netdev bridge,id=net0,br=br0 \
  -device virtio-net-pci,netdev=net0,bus=pcie.0,addr=0x2 \
  \
  -netdev bridge,id=net1,br=br1 \
  -device virtio-net-pci,netdev=net1,bus=pcie.0,addr=0x4 \
  \
  -netdev bridge,id=net2,br=br2 \
  -device virtio-net-pci,netdev=net2,bus=pcie.0,addr=0x6 \
  \
  -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,addr=0x3 \
  -device nec-usb-xhci,id=xhci,bus=pci.1,addr=0x0 \
  -device usb-tablet,bus=xhci.0 \
  \
  -audiodev pa,id=windows1 \
  -device ich9-intel-hda,id=sound0,bus=pcie.0,addr=0x1b \
  -device hda-duplex,bus=sound0.0,audiodev=windows1 \
  \
  -qmp tcp:"$QMP_SOCK",server,nowait
