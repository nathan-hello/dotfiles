#!/bin/bash
set -euo pipefail

QEMUPATH="$HOME/.qemu"
WINPATH="$QEMUPATH/win11"
ISOPATH="$QEMUPATH/iso"

DRIVEFILE="$WINPATH/win11_disk.qcow2"
VIRTIOFILE="$ISOPATH/virtio-win.iso"
WINISOFILE="$ISOPATH/win11.iso" # <-- Comment this out after installation

# We need a writable copy of the VARS file for the VM to store boot settings.
OVMF_VARS_COPY="$WINPATH/win11_VARS.fd"
OVMF_CODE="/usr/share/edk2/x64/OVMF_CODE.fd"

mkdir -p "$WINPATH" "$ISOPATH"

# Only copy the template if our own copy doesn't exist yet.
if [ ! -f "$OVMF_VARS_COPY" ]; then
    echo "Creating initial UEFI variable store..."
    cp "/usr/share/edk2/x64/OVMF_VARS.fd" "$OVMF_VARS_COPY"
fi

echo "Starting QEMU VM..."
qemu-system-x86_64 \
  -enable-kvm \
  -machine q35 \
  -m 8G \
  -cpu host \
  -smp 8,cores=4 \
  \
  -drive if=pflash,format=raw,readonly=on,file="$OVMF_CODE" \
  -drive if=pflash,format=raw,file="$OVMF_VARS_COPY" \
  \
  -device virtio-vga-gl \
  -display gtk,gl=on \
  \
  -drive file="$DRIVEFILE",format=qcow2,if=virtio \
  -cdrom "$WINISOFILE" \
  -drive file="$VIRTIOFILE",index=3,media=cdrom \
  \
  -netdev user,id=net0 \
  -device virtio-net-pci,netdev=net0 \
  \
  -device qemu-xhci \
  -device usb-tablet

echo "VM shut down."
